<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÇ Mathe Zug / Math Train</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Nunito', cursive;
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 50%, #1a237e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated clouds in background */
        .cloud {
            position: fixed;
            font-size: 50px;
            opacity: 0.15;
            animation: cloudMove linear infinite;
            pointer-events: none;
        }
        @keyframes cloudMove {
            0% { transform: translateX(-200px); }
            100% { transform: translateX(110vw); }
        }

        .container {
            background: white;
            border-radius: 30px;
            padding: 35px 30px;
            max-width: 480px;
            width: 95%;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            position: relative;
        }

        /* Language Toggle */
        .lang-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #FDD835;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            color: #0D47A1;
            transition: transform 0.2s;
        }
        .lang-toggle:hover { transform: scale(1.1); }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* ===== WELCOME SCREEN ===== */
        .train-bounce {
            font-size: 80px;
            text-align: center;
            margin: 15px 0;
            animation: bounce 1.2s ease-in-out infinite;
            display: block;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-12px) rotate(2deg); }
        }

        h1 {
            text-align: center;
            color: #1565C0;
            font-size: 2.3em;
            margin-bottom: 6px;
            text-shadow: 2px 2px 0px #FDD835;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 25px;
            font-size: 1em;
        }

        .grade-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .grade-btn {
            flex: 1;
            padding: 18px 10px;
            border: 4px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.25s;
            text-align: center;
        }
        .grade-btn:hover { transform: scale(1.05); border-color: #1565C0; }
        .grade-btn.selected {
            border-color: #1565C0;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(21,101,192,0.25);
        }
        .grade-num {
            font-size: 2.5em;
            font-weight: bold;
            color: #1565C0;
            display: block;
        }
        .grade-label {
            font-size: 0.85em;
            color: #666;
            display: block;
            margin-top: 4px;
        }

        .grade-topics {
            font-size: 0.7em;
            color: #999;
            margin-top: 5px;
            display: block;
        }

        .start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #D32F2F, #B71C1C);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
            margin-top: 5px;
            letter-spacing: 1px;
        }
        .start-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(211,47,47,0.45);
        }
        .start-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ===== QUIZ SCREEN ===== */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .score-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #1565C0;
            background: #E3F2FD;
            padding: 6px 14px;
            border-radius: 20px;
        }
        .timer-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #D32F2F;
            background: #FFEBEE;
            padding: 6px 14px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        .timer-display.urgent {
            animation: timerPulse 0.4s infinite;
            background: #D32F2F;
            color: white;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Train Progress Track */
        .track-wrapper {
            margin: 10px 0 20px;
            padding: 0 5px;
        }
        .track {
            background: #8D6E63;
            height: 18px;
            border-radius: 10px;
            position: relative;
            overflow: visible;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .track-fill {
            background: linear-gradient(90deg, #FDD835, #F9A825);
            height: 100%;
            border-radius: 10px;
            transition: width 0.6s ease;
            min-width: 0%;
        }
        .train-on-track {
            position: absolute;
            top: -18px;
            font-size: 38px;
            line-height: 1;
            transition: left 0.6s ease;
            transform: translateX(-50%);
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }
        .track-sleepers {
            display: flex;
            justify-content: space-around;
            margin-top: 4px;
        }
        .sleeper {
            width: 6px;
            height: 8px;
            background: #5D4037;
            border-radius: 2px;
        }

        .question-num {
            text-align: center;
            color: #aaa;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .question {
            text-align: center;
            font-size: 2.8em;
            font-weight: bold;
            color: #1565C0;
            margin: 12px 0;
            padding: 20px;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-radius: 20px;
            border: 3px solid #90CAF9;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .answer-btn {
            padding: 18px 10px;
            font-size: 1.7em;
            font-weight: bold;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            color: #333;
        }
        .answer-btn:hover:not(:disabled) {
            transform: scale(1.07);
            border-color: #1565C0;
            background: #E3F2FD;
            color: #1565C0;
        }
        .answer-btn.correct {
            background: linear-gradient(135deg, #43A047, #2E7D32);
            color: white;
            border-color: #2E7D32;
            transform: scale(1.07);
        }
        .answer-btn.wrong {
            background: linear-gradient(135deg, #E53935, #C62828);
            color: white;
            border-color: #C62828;
        }
        .answer-btn:disabled { cursor: not-allowed; }

        /* ===== RESULTS SCREEN ===== */
        .result-emoji {
            font-size: 90px;
            text-align: center;
            display: block;
            margin: 10px 0;
            animation: resultPop 0.5s ease;
        }
        @keyframes resultPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .result-score {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #1565C0;
            margin: 10px 0;
        }

        .stars-row {
            text-align: center;
            font-size: 2em;
            margin: 5px 0;
        }

        .result-message {
            text-align: center;
            color: #555;
            font-size: 1.15em;
            margin: 10px 0 25px;
            padding: 0 10px;
            line-height: 1.4;
        }

        .btn-row {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.25s;
        }
        .btn-home {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            color: white;
        }
        .btn-retry {
            background: linear-gradient(135deg, #D32F2F, #B71C1C);
            color: white;
        }
        .action-btn:hover { transform: scale(1.05); }

        /* ===== ANIMATIONS ===== */
        .feedback-popup {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 5em;
            animation: feedbackAnim 0.7s ease forwards;
            pointer-events: none;
            z-index: 999;
        }
        @keyframes feedbackAnim {
            0%   { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            40%  { transform: translate(-50%, -50%) scale(1.6); opacity: 1; }
            100% { transform: translate(-50%, -60%) scale(1); opacity: 0; }
        }

        .confetti-piece {
            position: fixed;
            border-radius: 3px;
            animation: confettiFall linear forwards;
            pointer-events: none;
            z-index: 998;
        }
        @keyframes confettiFall {
            0%   { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(900deg); opacity: 0; }
        }
    </style>
</head>
<body>

<!-- Background clouds -->
<div class="cloud" style="top:10%; animation-duration:18s; animation-delay:0s;">‚òÅÔ∏è</div>
<div class="cloud" style="top:30%; animation-duration:25s; animation-delay:5s;">‚òÅÔ∏è</div>
<div class="cloud" style="top:60%; animation-duration:20s; animation-delay:10s;">‚òÅÔ∏è</div>
<div class="cloud" style="top:80%; animation-duration:22s; animation-delay:2s;">‚òÅÔ∏è</div>

<div class="container">

    <!-- Language toggle (visible on all screens) -->
    <button class="lang-toggle" onclick="toggleLang()" id="langBtn">üá©üá™ DE</button>

    <!-- ===== WELCOME SCREEN ===== -->
    <div class="screen active" id="welcomeScreen">
        <span class="train-bounce">üöÇ</span>
        <h1 id="welcomeTitle">Mathe Zug!</h1>
        <p class="subtitle" id="welcomeSubtitle">W√§hle deine Klasse üëá</p>

        <div class="grade-buttons">
            <button class="grade-btn" id="gradeBtn1" onclick="selectGrade(1)">
                <span class="grade-num">1</span>
                <span class="grade-label" id="gradeLabel1">Klasse</span>
                <span class="grade-topics" id="gradeTopics1">+ und ‚àí bis 20</span>
            </button>
            <button class="grade-btn" id="gradeBtn2" onclick="selectGrade(2)">
                <span class="grade-num">2</span>
                <span class="grade-label" id="gradeLabel2">Klasse</span>
                <span class="grade-topics" id="gradeTopics2">+ ‚àí bis 100, √ó</span>
            </button>
        </div>

        <button class="start-btn" id="startBtn" onclick="startGame()" disabled>
            üöÇ <span id="startLabel">Los geht's!</span>
        </button>
    </div>

    <!-- ===== QUIZ SCREEN ===== -->
    <div class="screen" id="quizScreen">
        <div class="stats-bar">
            <div class="score-display">‚≠ê <span id="scoreDisplay">0</span>/10</div>
            <div class="timer-display" id="timerDisplay">‚è±Ô∏è 30</div>
        </div>

        <div class="track-wrapper">
            <div class="track">
                <div class="track-fill" id="trackFill" style="width:0%"></div>
                <div class="train-on-track" id="trainOnTrack" style="left:0%">üöÖ</div>
            </div>
            <div class="track-sleepers">
                <div class="sleeper"></div><div class="sleeper"></div>
                <div class="sleeper"></div><div class="sleeper"></div>
                <div class="sleeper"></div><div class="sleeper"></div>
                <div class="sleeper"></div><div class="sleeper"></div>
                <div class="sleeper"></div><div class="sleeper"></div>
            </div>
        </div>

        <div class="question-num" id="questionNum">Aufgabe 1 von 10</div>
        <div class="question" id="questionDisplay">_ + _ = ?</div>

        <div class="answers" id="answersGrid">
            <button class="answer-btn" onclick="checkAnswer(this)">?</button>
            <button class="answer-btn" onclick="checkAnswer(this)">?</button>
            <button class="answer-btn" onclick="checkAnswer(this)">?</button>
            <button class="answer-btn" onclick="checkAnswer(this)">?</button>
        </div>
    </div>

    <!-- ===== RESULTS SCREEN ===== -->
    <div class="screen" id="resultsScreen">
        <span class="result-emoji" id="resultEmoji">üèÜ</span>
        <div class="result-score" id="resultScore">10/10</div>
        <div class="stars-row" id="starsRow">‚≠ê‚≠ê‚≠ê</div>
        <div class="result-message" id="resultMessage">Super gemacht!</div>

        <div class="btn-row">
            <button class="action-btn btn-home" onclick="goHome()">
                üè† <span id="homeBtnLabel">Start</span>
            </button>
            <button class="action-btn btn-retry" onclick="startGame()">
                üîÑ <span id="retryBtnLabel">Nochmal!</span>
            </button>
        </div>
    </div>

</div>

<script>
// ============================================
// LANGUAGE DATA
// ============================================
const LANG = {
    de: {
        title: 'Mathe Zug!',
        subtitle: 'W√§hle deine Klasse üëá',
        gradeLabel: 'Klasse',
        gradeTopics1: '+ und ‚àí bis 20',
        gradeTopics2: '+ ‚àí bis 100, √ó',
        start: "Los geht's! üöÇ",
        questionWord: 'Aufgabe',
        ofWord: 'von',
        home: 'üè† Start',
        retry: 'üîÑ Nochmal!',
        results: {
            perfect:   ['üèÜ PERFEKT! Du bist ein Mathe-Superstar!', 'üåü Alle 10 richtig! Unglaublich!'],
            great:     ['‚≠ê Super gemacht! Fast perfekt!', 'üéâ Klasse! Du bist sehr gut!'],
            good:      ['üëç Gut gemacht! Weiter so!', 'üòä Sch√∂n! Du lernst schnell!'],
            ok:        ['üí™ Nicht schlecht! √úbe weiter!', 'üöÇ Choo choo! Du schaffst das!'],
            tryAgain:  ['üîÑ Versuch es nochmal! Du wirst besser!', 'üí° √úben macht den Meister!']
        }
    },
    en: {
        title: 'Math Train!',
        subtitle: 'Choose your grade üëá',
        gradeLabel: 'Grade',
        gradeTopics1: '+ and ‚àí up to 20',
        gradeTopics2: '+ ‚àí up to 100, √ó',
        start: "Let's go! üöÇ",
        questionWord: 'Question',
        ofWord: 'of',
        home: 'üè† Home',
        retry: 'üîÑ Again!',
        results: {
            perfect:   ['üèÜ PERFECT! You are a Math Superstar!', 'üåü All 10 correct! Amazing!'],
            great:     ['‚≠ê Great job! Almost perfect!', 'üéâ Excellent! You are very good!'],
            good:      ['üëç Good job! Keep it up!', 'üòä Nice! You learn fast!'],
            ok:        ['üí™ Not bad! Keep practicing!', 'üöÇ Choo choo! You can do it!'],
            tryAgain:  ['üîÑ Try again! You will get better!', 'üí° Practice makes perfect!']
        }
    }
};

// ============================================
// GAME STATE
// ============================================
let lang = 'de';
let selectedGrade = null;
let currentQ = 0;
let score = 0;
let correctAnswer = 0;
let timerInterval = null;
let timeLeft = 30;
const TOTAL = 10;
let audioCtx = null;

// ============================================
// AUDIO
// ============================================
function getCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
}

function playSound(type) {
    try {
        const ctx = getCtx();
        if (type === 'correct') {
            [523, 659, 784].forEach((f, i) => {
                const o = ctx.createOscillator(), g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.value = f;
                g.gain.setValueAtTime(0.25, ctx.currentTime + i*0.12);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i*0.12 + 0.15);
                o.start(ctx.currentTime + i*0.12);
                o.stop(ctx.currentTime + i*0.12 + 0.15);
            });
        } else if (type === 'wrong') {
            const o = ctx.createOscillator(), g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.setValueAtTime(220, ctx.currentTime);
            o.frequency.setValueAtTime(150, ctx.currentTime + 0.15);
            g.gain.setValueAtTime(0.3, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
            o.start(); o.stop(ctx.currentTime + 0.35);
        } else if (type === 'train') {
            const o = ctx.createOscillator(), g = ctx.createGain();
            o.type = 'sawtooth';
            o.connect(g); g.connect(ctx.destination);
            o.frequency.setValueAtTime(180, ctx.currentTime);
            o.frequency.setValueAtTime(120, ctx.currentTime + 0.25);
            g.gain.setValueAtTime(0.15, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            o.start(); o.stop(ctx.currentTime + 0.5);
        } else if (type === 'victory') {
            [523, 659, 784, 1047].forEach((f, i) => {
                const o = ctx.createOscillator(), g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.value = f;
                g.gain.setValueAtTime(0.25, ctx.currentTime + i*0.18);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i*0.18 + 0.2);
                o.start(ctx.currentTime + i*0.18);
                o.stop(ctx.currentTime + i*0.18 + 0.25);
            });
        }
    } catch(e) { /* audio not available */ }
}

// ============================================
// LANGUAGE
// ============================================
function toggleLang() {
    lang = lang === 'de' ? 'en' : 'de';
    document.getElementById('langBtn').textContent = lang === 'de' ? 'üá©üá™ DE' : 'üá¨üáß EN';
    applyLang();
}

function applyLang() {
    const t = LANG[lang];
    document.getElementById('welcomeTitle').textContent = t.title;
    document.getElementById('welcomeSubtitle').textContent = t.subtitle;
    document.getElementById('gradeLabel1').textContent = t.gradeLabel;
    document.getElementById('gradeLabel2').textContent = t.gradeLabel;
    document.getElementById('gradeTopics1').textContent = t.gradeTopics1;
    document.getElementById('gradeTopics2').textContent = t.gradeTopics2;
    document.getElementById('startLabel').textContent = t.start;
    document.getElementById('homeBtnLabel').textContent = t.home;
    document.getElementById('retryBtnLabel').textContent = t.retry;
    refreshQuestionNum();
}

// ============================================
// GRADE SELECTION
// ============================================
function selectGrade(g) {
    selectedGrade = g;
    document.getElementById('gradeBtn1').classList.toggle('selected', g === 1);
    document.getElementById('gradeBtn2').classList.toggle('selected', g === 2);
    document.getElementById('startBtn').disabled = false;
    playSound('train');
}

// ============================================
// MATH GENERATION
// ============================================
function makeQuestion(grade) {
    let a, b, op, answer;
    const ops = grade === 1 ? ['+', '-'] : ['+', '-', '√ó'];
    op = ops[Math.floor(Math.random() * ops.length)];

    if (grade === 1) {
        if (op === '+') {
            a = rand(1, 10); b = rand(1, 20 - a); answer = a + b;
        } else {
            a = rand(2, 20); b = rand(1, a - 1); answer = a - b;
        }
    } else {
        if (op === '+') {
            a = rand(10, 80); b = rand(5, 100 - a); answer = a + b;
        } else if (op === '-') {
            a = rand(20, 100); b = rand(1, a - 1); answer = a - b;
        } else {
            a = rand(2, 10); b = rand(2, 5); answer = a * b;
        }
    }
    return { display: `${a} ${op} ${b} = ?`, answer };
}

function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function makeWrongAnswers(correct) {
    const set = new Set();
    let attempts = 0;
    while (set.size < 3 && attempts < 50) {
        attempts++;
        const delta = rand(1, 9) * (Math.random() < 0.5 ? 1 : -1);
        const w = correct + delta;
        if (w !== correct && w >= 0) set.add(w);
    }
    return [...set];
}

function shuffle(arr) {
    return [...arr].sort(() => Math.random() - 0.5);
}

// ============================================
// GAME FLOW
// ============================================
function startGame() {
    if (!selectedGrade) return;
    currentQ = 0;
    score = 0;
    showScreen('quizScreen');
    updateScore();
    playSound('train');
    loadQuestion();
}

function loadQuestion() {
    if (currentQ >= TOTAL) { showResults(); return; }

    // Progress track
    const pct = (currentQ / TOTAL) * 100;
    document.getElementById('trackFill').style.width = pct + '%';
    document.getElementById('trainOnTrack').style.left = Math.max(pct, 2) + '%';

    refreshQuestionNum();

    // Generate question
    const { display, answer } = makeQuestion(selectedGrade);
    correctAnswer = answer;
    document.getElementById('questionDisplay').textContent = display;

    // Set answer buttons
    const options = shuffle([answer, ...makeWrongAnswers(answer)]);
    const btns = document.querySelectorAll('.answer-btn');
    btns.forEach((btn, i) => {
        btn.textContent = options[i];
        btn.dataset.val = options[i];
        btn.className = 'answer-btn';
        btn.disabled = false;
    });

    startTimer();
}

function refreshQuestionNum() {
    const t = LANG[lang];
    const el = document.getElementById('questionNum');
    if (el) el.textContent = `${t.questionWord} ${currentQ + 1} ${t.ofWord} ${TOTAL}`;
}

// ============================================
// TIMER
// ============================================
function startTimer() {
    clearInterval(timerInterval);
    timeLeft = 30;
    renderTimer();
    timerInterval = setInterval(() => {
        timeLeft--;
        renderTimer();
        if (timeLeft <= 0) { clearInterval(timerInterval); onTimeout(); }
    }, 1000);
}

function renderTimer() {
    const el = document.getElementById('timerDisplay');
    el.textContent = `‚è±Ô∏è ${timeLeft}`;
    el.className = 'timer-display' + (timeLeft <= 5 ? ' urgent' : '');
}

function onTimeout() {
    disableButtons();
    highlightCorrect();
    playSound('wrong');
    showFeedback('‚è∞');
    setTimeout(nextQuestion, 1500);
}

// ============================================
// ANSWER CHECKING
// ============================================
function checkAnswer(btn) {
    clearInterval(timerInterval);
    disableButtons();

    const chosen = parseInt(btn.dataset.val);
    if (chosen === correctAnswer) {
        btn.classList.add('correct');
        score++;
        updateScore();
        playSound('correct');
        showFeedback('‚≠ê');
        launchConfetti(20);
    } else {
        btn.classList.add('wrong');
        highlightCorrect();
        playSound('wrong');
        showFeedback('‚ùå');
    }
    setTimeout(nextQuestion, 1400);
}

function nextQuestion() {
    currentQ++;
    loadQuestion();
}

function disableButtons() {
    document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
}

function highlightCorrect() {
    document.querySelectorAll('.answer-btn').forEach(b => {
        if (parseInt(b.dataset.val) === correctAnswer) b.classList.add('correct');
    });
}

function updateScore() {
    document.getElementById('scoreDisplay').textContent = score;
}

// ============================================
// RESULTS
// ============================================
function showResults() {
    clearInterval(timerInterval);

    // Full track
    document.getElementById('trackFill').style.width = '100%';
    document.getElementById('trainOnTrack').style.left = '97%';

    showScreen('resultsScreen');

    const pct = (score / TOTAL) * 100;
    const t = LANG[lang];
    let emoji, msgArr, stars;

    if (pct === 100) {
        emoji = 'üèÜ'; stars = '‚≠ê‚≠ê‚≠ê'; msgArr = t.results.perfect;
        playSound('victory');
        launchConfetti(60);
        setTimeout(() => launchConfetti(40), 600);
    } else if (pct >= 80) {
        emoji = 'üåü'; stars = '‚≠ê‚≠ê‚≠ê'; msgArr = t.results.great;
        playSound('victory');
        launchConfetti(35);
    } else if (pct >= 60) {
        emoji = 'üòä'; stars = '‚≠ê‚≠ê'; msgArr = t.results.good;
        playSound('correct');
    } else if (pct >= 40) {
        emoji = 'üí™'; stars = '‚≠ê'; msgArr = t.results.ok;
    } else {
        emoji = 'üöÇ'; stars = ''; msgArr = t.results.tryAgain;
    }

    document.getElementById('resultEmoji').textContent = emoji;
    document.getElementById('resultScore').textContent = `${score} / ${TOTAL}`;
    document.getElementById('starsRow').textContent = stars;
    document.getElementById('resultMessage').textContent = msgArr[Math.floor(Math.random() * msgArr.length)];
}

function goHome() {
    showScreen('welcomeScreen');
    playSound('train');
}

// ============================================
// VISUAL EFFECTS
// ============================================
function showFeedback(emoji) {
    const el = document.createElement('div');
    el.className = 'feedback-popup';
    el.textContent = emoji;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 700);
}

function launchConfetti(count) {
    const colors = ['#1565C0', '#D32F2F', '#FDD835', '#4CAF50', '#FF9800', '#9C27B0', '#00BCD4'];
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'confetti-piece';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = '-20px';
            p.style.background = colors[Math.floor(Math.random() * colors.length)];
            p.style.width = (Math.random() * 10 + 6) + 'px';
            p.style.height = (Math.random() * 10 + 6) + 'px';
            p.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
            p.style.animationDelay = (Math.random() * 0.3) + 's';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 4000);
        }, i * 40);
    }
}

// ============================================
// SCREEN SWITCHING
// ============================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
